# Payday 상세 구현 매뉴얼 (Step-by-Step Implementation Manual)

본 문서는 `payday_comprehensive_guide.md`보다 심층적이며, 실제 코드를 작성하고 파일을 생성하는 모든 과정을 "따라 하기만 하면 완성되도록" 매우 상세하게 기술한 **마스터 가이드**입니다.

---

## 1단계: 환경 설정 및 프로젝트 초기화 (Phase 1: Environment & Project Init)

### 1-1. 웹 서버 및 DB 설치
1.  **XAMPP 설치 (Windows 기준):**
    - Apache, MySQL이 포함된 XAMPP 최신 버전을 다운로드하여 설치합니다.
    - 설치 경로: `C:\xampp` (권장)
2.  **프로젝트 폴더 생성:**
    - `C:\xampp\htdocs` 폴더 내에 `payday` 폴더를 생성합니다.
    - 최종 경로: `C:\xampp\htdocs\payday`

### 1-2. 필수 디렉토리 구조 생성
`payday` 폴더 안에 다음 하위 폴더들을 생성합니다. (명령 프롬프트 또는 탐색기 사용)

```bash
mkdir css js pages process uploads backup includes
```

### 1-3. 파일 권한 설정 (Linux/Mac의 경우)
- `uploads` 폴더에 대해 쓰기 권한을 부여합니다.
- `chmod 775 uploads`

---

## 2단계: 데이터베이스 구축 (Phase 2: Database Construction)

### 2-1. 데이터베이스 생성
phpMyAdmin (`http://localhost/phpmyadmin`) 또는 MySQL 클라이언트에 접속하여 다음 SQL을 실행합니다.

```sql
CREATE DATABASE IF NOT EXISTS payday CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
USE payday;
```

### 2-2. 핵심 테이블 생성 (상세 스키마)
다음 SQL 쿼리를 정확히 순서대로 실행하여 테이블을 생성합니다.

#### (1) 회사 정보 (company_info)
```sql
CREATE TABLE `company_info` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `company_name` varchar(255) DEFAULT NULL,
  `ceo_name` varchar(100) DEFAULT NULL,
  `biz_reg_number` varchar(50) DEFAULT NULL COMMENT '사업자등록번호',
  `loan_reg_number` varchar(50) DEFAULT NULL COMMENT '대부업등록번호',
  `phone` varchar(20) DEFAULT NULL,
  `fax` varchar(20) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `address` varchar(255) DEFAULT NULL,
  `logo_path` varchar(255) DEFAULT NULL,
  `seal_path` varchar(255) DEFAULT NULL,
  `interest_account` varchar(255) DEFAULT NULL COMMENT '이자수취계좌',
  `expense_account` varchar(255) DEFAULT NULL COMMENT '경비수취계좌',
  `slack_notifications_enabled` tinyint(1) DEFAULT 1,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### (2) 고객 (customers)
```sql
CREATE TABLE `customers` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL,
  `resident_id` varchar(20) DEFAULT NULL COMMENT '주민등록번호/법인번호',
  `phone` varchar(20) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `address_registered` varchar(255) DEFAULT NULL COMMENT '등본 주소',
  `address_real` varchar(255) DEFAULT NULL COMMENT '실거주 주소',
  `company_name` varchar(100) DEFAULT NULL COMMENT '직장/사업장명',
  `memo` text DEFAULT NULL,
  `created_at` timestamp DEFAULT current_timestamp(),
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### (3) 계약 (contracts)
가장 중요한 테이블입니다. `DECIMAL` 타입을 필수로 사용해야 합니다.

```sql
CREATE TABLE `contracts` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `customer_id` int(11) NOT NULL,
  `product_name` varchar(100) DEFAULT '일반담보대출',
  `loan_amount` decimal(15,2) NOT NULL DEFAULT 0.00 COMMENT '대출원금',
  `interest_rate` decimal(5,2) NOT NULL DEFAULT 0.00 COMMENT '정상금리(%)',
  `overdue_interest_rate` decimal(5,2) NOT NULL DEFAULT 0.00 COMMENT '연체금리(%)',
  `loan_date` date NOT NULL,
  `maturity_date` date NOT NULL,
  `contract_day` int(11) NOT NULL COMMENT '약정일(매월 N일)',
  `status` enum('active','paid','overdue','defaulted') DEFAULT 'active',
  `current_outstanding_principal` decimal(15,2) DEFAULT 0.00 COMMENT '현재 잔액',
  `shortfall_amount` decimal(15,2) DEFAULT 0.00 COMMENT '이자 부족금 누적액',
  `last_interest_calc_date` date DEFAULT NULL COMMENT '마지막 이자 정산일',
  `next_due_date` date DEFAULT NULL COMMENT '차회 납입 기일',
  `created_at` timestamp DEFAULT current_timestamp(),
  PRIMARY KEY (`id`),
  FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### (4) 수납 (collections) - 트랜잭션 기록
```sql
CREATE TABLE `collections` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `transaction_id` varchar(50) DEFAULT NULL COMMENT '트랜잭션 그룹 ID',
  `contract_id` int(11) NOT NULL,
  `collection_date` date NOT NULL COMMENT '수납일',
  `collection_type` varchar(20) NOT NULL COMMENT '이자/원금/경비',
  `amount` decimal(15,2) NOT NULL DEFAULT 0.00,
  `generated_interest` decimal(15,2) DEFAULT 0.00 COMMENT '당일 발생 이자(참고용)',
  `memo` text DEFAULT NULL,
  `deleted_at` datetime DEFAULT NULL,
  `deleted_by` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_collection_date` (`collection_date`),
  KEY `idx_contract_id` (`contract_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### (5) 조건 변경 (condition_changes)
```sql
CREATE TABLE `condition_changes` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `contract_id` int(11) NOT NULL,
  `change_date` date NOT NULL COMMENT '변경 적용일',
  `new_interest_rate` decimal(5,2) DEFAULT NULL,
  `new_overdue_rate` decimal(5,2) DEFAULT NULL,
  `memo` text DEFAULT NULL,
  `created_at` timestamp DEFAULT current_timestamp(),
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 3단계: 공통 모듈 및 설정 파일 개발 (Phase 3: Core Implementation)

### 3-1. DB 연결 설정 (`config.php`)
`payday/config.php` 파일을 생성하고 다음 코드를 작성합니다.

```php
<?php
define('DB_SERVER', 'localhost');
define('DB_USERNAME', 'root'); // 본인의 설정에 맞게 변경
define('DB_PASSWORD', '');     // 본인의 설정에 맞게 변경
define('DB_NAME', 'payday');

$link = mysqli_connect(DB_SERVER, DB_USERNAME, DB_PASSWORD, DB_NAME);

if($link === false){
    die("ERROR: Could not connect. " . mysqli_connect_error());
}
?>
```

### 3-2. 공통 함수 라이브러리 (`common.php`) - **핵심 로직**
`payday/common.php` 파일을 생성합니다. 이곳에 모든 핵심 비즈니스 로직이 담깁니다.

#### (1) 금리 조회 함수 (`get_interest_rate_history`)
조건 변경 이력을 모두 가져와 날짜별로 정렬하는 함수입니다. 이자 계산 시 반드시 필요합니다.

```php
function get_interest_rate_history($link, $contract_id, $contract = null) {
    if (!$contract) {
        // contract 정보 조회 쿼리 필요 (생략 가능, 인자로 받음)
    }
    // 1. 초기 금리 설정
    $history = [];
    $history[] = [
        'start_date' => $contract['loan_date'],
        'interest_rate' => $contract['interest_rate'],
        'overdue_rate' => $contract['overdue_interest_rate']
    ];
    // 2. 변경 이력 조회
    $sql = "SELECT change_date, new_interest_rate, new_overdue_rate FROM condition_changes WHERE contract_id = ? ORDER BY change_date ASC";
    // ... mysqli_prepare 및 execute ...
    // history 배열에 추가 후 리턴
    return $history;
}
```

#### (2) 기간별 이자 계산 (`calculateAccruedInterestForPeriod`)
가장 복잡한 함수입니다. 시작일~종료일 사이를 루프 돌며 일할 계산합니다.

```php
function calculateAccruedInterestForPeriod($link, $contract, $principal, $start_date_str, $end_date_str, $due_date_str) {
    $start_date = new DateTime($start_date_str);
    $end_date = new DateTime($end_date_str);
    $due_date = new DateTime($due_date_str);
    
    // ... 금리 이력 조회 ...
    
    // 날짜별 루프 (for loop)
    // 윤년 체크: date('L', $timestamp)
    // 이자 = 원금 * (금리/100) / 365 (또는 366)
    // 연체 여부 판별 ($current_date >= $due_date) -> 연체 금리 적용
    
    return ['normal' => $calc_normal, 'overdue' => $calc_overdue, 'total' => $total];
}
```

#### (3) 수납 처리 (`process_collection`) - **분개 로직**
입금된 총액을 우선순위에 따라 나누어 저장하는 함수입니다.

```php
function process_collection($link, $contract_id, $collection_date, $total_amount, ...) {
    // 1. 트랜잭션 시작
    mysqli_begin_transaction($link);
    
    try {
        // 2. 금액 배분 (경비 > 이자 > 원금)
        // ...
        
        // 3. insert 쿼리 실행 (collections 테이블)
        // ...
        
        // 4. 계약 상태 업데이트 (contracts 테이블 - outstanding_principal, shortfall 차감)
        // ...
        
        mysqli_commit($link);
    } catch (Exception $e) {
        mysqli_rollback($link);
        throw $e;
    }
}
```

---

## 4단계: UX/UI 페이지 개발 (Phase 4: Pages)

### 4-1. 공통 레이아웃 (`header.php`, `footer.php`, `sidebar.php`)
모든 페이지에 `require_once 'pages/header.php';`를 상단에 넣어 통일성을 유지합니다. `sidebar.php`에는 메뉴 링크(`contract_manage.php`, `collection_manage.php` 등)를 배치합니다.

### 4-2. 계약 관리 (`pages/contract_manage.php`)
- **기능:** 고객 및 계약 신규 등록.
- **UI:** `<form>` 태그를 사용해 `process/contract_process.php`로 POST 요청을 보냅니다.
- **Tip:** 금액 입력 필드에는 천단위 콤마 자동 입력 자바스크립트를 적용하면 좋습니다.

### 4-3. 수납 관리 (`pages/collection_manage.php`)
- **기능:** 특정 계약을 선택하고 입금 처리를 수행.
- **로직:**
    1.  계약 선택 시 AJAX로 현재 미수 이자(`shortfall`)와 원금을 조회.
    2.  입금일(`collection_date`) 입력 시, 마지막 수납일 이후부터 입금일까지의 발생 이자를 AJAX로 계산하여 화면에 표시(`calculateAccruedInterest` 호출).
    3.  '저장' 버튼 클릭 시 `process_collection` 함수 실행.

### 4-4. 사용자 매뉴얼 (`pages/manual.php`)
- **구조:** `<details>`, `<summary>` 태그를 사용하여 질문/답변 형식으로 구성.
- **기능:** 인쇄 버튼 클릭 시 `@media print` CSS가 적용되어 깔끔하게 출력되도록 구현 (앞서 수행한 작업).

---

## 5단계: 최종 점검 및 운영 (Phase 5: Deploy & Maintenance)

1.  **로그인 테스트:** `admin` / `password` (초기 설정 계정)으로 로그인 되는지 확인.
2.  **이자 계산 검증:**
    - 1억 원, 10%, 1월 1일 대출 -> 2월 1일 이자 계산 시 액셀 값과 1원 단위까지 일치하는지 확인.
    - 윤년(2월 29일 포함) 기간 테스트 필수.
3.  **백업 스케줄링:** 운영 서버(Linux)의 경우 `crontab`을 설정하여 매일 밤 DB 덤프를 뜨도록 설정.
    ```bash
    0 3 * * * mysqldump -u root -p'password' payday > /backup/payday_$(date +\%F).sql
    ```

이 매뉴얼의 각 단계, 특히 **DB 스키마와 common.php의 로직**을 정확히 구현한다면 Payday 시스템을 성공적으로 완성할 수 있습니다.
